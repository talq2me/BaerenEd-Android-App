<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Long Division</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #FF9800;
            --correct-color: #8BC34A;
            --wrong-color: #F44336;
            --border-color: #333;
            --input-bg: #fff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Comic Sans MS', 'Chalkboard', 'Arial Rounded MT Bold', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .game-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            gap: 20px;
        }
        .main-content { flex: 1; min-width: 0; }
        .number-pad-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }
        .number-pad-row {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .number-pad-button {
            width: 55px;
            height: 55px;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .number-pad-button:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .number-pad-button:active {
            transform: translateY(0);
            background: #e0e0e0;
        }
        .number-pad-button.delete {
            background: var(--wrong-color);
            color: white;
            border-color: #c62828;
        }
        .number-pad-button.delete:hover { background: #d32f2f; }
        @media (max-width: 768px) {
            .game-container { flex-direction: column; }
            .number-pad-container { flex-direction: row; flex-wrap: wrap; justify-content: center; }
            .number-pad-button { width: 50px; height: 50px; font-size: 1.2rem; }
        }
        .question {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }
        .division-container {
            font-size: 1.8rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .division-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 2px 0;
        }
        .digit-cell {
            width: 46px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background: var(--input-bg);
            font-size: 1.6rem;
            font-weight: bold;
            text-align: center;
        }
        .digit-cell.input {
            background: #f0f0f0;
            cursor: text;
            width: 42px;
            height: 48px;
            font-size: 1.5rem;
        }
        .digit-cell.input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }
        .digit-cell.input.error {
            border-color: var(--wrong-color);
            background: #ffebee;
            animation: shake 0.3s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .division-r { font-size: 1.2rem; color: #333; margin: 0 6px; font-weight: bold; }
        .division-bracket { margin-right: 8px; }
        .division-line {
            height: 2px;
            background: var(--border-color);
            margin: 2px 0;
            min-width: 60px;
        }
        .division-subtract { font-size: 1rem; color: #666; margin-left: 4px; }
        .error-message {
            color: var(--wrong-color);
            font-size: 1rem;
            text-align: center;
            margin-top: 10px;
            min-height: 25px;
            font-weight: bold;
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--confetti-color);
            animation: confetti-fall 3s ease-out forwards;
            z-index: 1000;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .score { font-size: 1.5rem; color: #666; margin-bottom: 20px; }
        .progress { font-size: 1rem; color: #999; margin-bottom: 10px; }
        .next-button {
            display: none;
            margin-top: 20px;
            padding: 15px 30px;
            font-size: 1.2rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
            width: 100%;
        }
        .next-button:hover { background: #45a049; transform: scale(1.05); }
        .next-button:active { transform: scale(0.95); }
        .hint-text { font-size: 0.9rem; color: #666; text-align: center; margin-top: 10px; font-style: italic; }
        .spacer { width: 46px; flex-shrink: 0; }
        .spacer-left { flex-shrink: 0; } /* width/min-width set in JS so inputs align with leftmost digit of numerator */
    </style>
</head>
<body>
    <div class="game-container">
        <div class="main-content">
            <div class="score">Score: <span id="score">0</span></div>
            <div class="progress">Questions: <span id="progress">0</span> / <span id="maxQuestions">10</span></div>
            <div class="question" id="question"></div>
            <div class="division-container" id="divisionProblem"></div>
            <div class="error-message" id="errorMessage"></div>
            <div class="hint-text" id="hintText"></div>
            <button class="next-button" id="nextButton">Next Question</button>
        </div>
        <div class="number-pad-container" id="numberPad">
            <div class="number-pad-row">
                <button class="number-pad-button" data-number="7">7</button>
                <button class="number-pad-button" data-number="8">8</button>
                <button class="number-pad-button" data-number="9">9</button>
            </div>
            <div class="number-pad-row">
                <button class="number-pad-button" data-number="4">4</button>
                <button class="number-pad-button" data-number="5">5</button>
                <button class="number-pad-button" data-number="6">6</button>
            </div>
            <div class="number-pad-row">
                <button class="number-pad-button" data-number="1">1</button>
                <button class="number-pad-button" data-number="2">2</button>
                <button class="number-pad-button" data-number="3">3</button>
            </div>
            <div class="number-pad-row">
                <button class="number-pad-button" data-number="0">0</button>
                <button class="number-pad-button delete" id="deleteButton">âŒ«</button>
            </div>
        </div>
    </div>

    <script>
        let currentProblem = null;
        let score = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        let problems = [];
        let currentProblemIndex = 0;
        const urlParams = new URLSearchParams(window.location.search);
        const totalQuestionsParam = urlParams.get('totalQuestions');
        let maxQuestions = 10;
        if (totalQuestionsParam) {
            const parsed = parseInt(totalQuestionsParam, 10);
            if (!isNaN(parsed) && parsed > 0) maxQuestions = parsed;
        }
        let questionsCompleted = 0;
        let allInputs = [];
        let skipCursorMove = false;

        function isAndroidWebView() { return typeof window.Android !== 'undefined'; }

        function loadConfig() {
            try {
                let configJson = '{}';
                if (isAndroidWebView() && typeof window.Android.getConfigJson === 'function') {
                    configJson = window.Android.getConfigJson();
                } else {
                    const saved = localStorage.getItem('longDivisionConfig');
                    if (saved) configJson = saved;
                }
                const config = JSON.parse(configJson);
                if (!totalQuestionsParam) {
                    if (config.sections && config.sections.length) {
                        for (const s of config.sections) {
                            if (s.tasks && s.tasks.length) {
                                for (const t of s.tasks) {
                                    if (t.questionsToComplete) {
                                        maxQuestions = parseInt(t.questionsToComplete, 10) || maxQuestions;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    if (config.questionsToComplete) maxQuestions = parseInt(config.questionsToComplete, 10) || maxQuestions;
                }
            } catch (e) {}
        }

        function generateProblems() {
            problems = [];
            for (let i = 0; i < 40; i++) {
                const dividendLen = Math.floor(Math.random() * 4) + 1;
                const divisorLen = Math.floor(Math.random() * 2) + 1;
                let dividend = generateNumber(dividendLen);
                let divisor = generateNumber(divisorLen);
                if (divisor === 0) divisor = 1;
                if (dividend < divisor) { const t = dividend; dividend = divisor; divisor = t; }
                const quotient = Math.floor(dividend / divisor);
                const remainder = dividend % divisor;
                if (quotient > 0 && quotient <= 9999) {
                    problems.push({
                        question: 'Divide. Write the quotient and remainder.',
                        dividend,
                        divisor,
                        quotient,
                        remainder
                    });
                }
            }
            shuffleArray(problems);
            maxQuestions = Math.min(problems.length, maxQuestions);
        }

        function generateNumber(numDigits) {
            const min = numDigits === 1 ? 1 : Math.pow(10, numDigits - 1);
            const max = Math.pow(10, numDigits) - 1;
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        /**
         * Compute long division steps: quotient digits and products at each step.
         * Returns { quotientDigits: number[], remainder: number, steps: [{ quotientDigit, product, offset }] }
         * offset = column index in dividend where this step's product starts (0 = left).
         */
        function computeLongDivisionSteps(dividend, divisor) {
            const quotientDigits = [];
            const steps = [];
            const dividendStr = String(dividend);
            let position = 0;
            let current = 0;

            while (position < dividendStr.length) {
                current = current * 10 + parseInt(dividendStr[position], 10);
                if (current < divisor && position < dividendStr.length - 1) {
                    position++;
                    continue;
                }
                const q = Math.floor(current / divisor);
                const product = q * divisor;
                const stepIndex = quotientDigits.length;
                quotientDigits.push(q);
                steps.push({
                    quotientDigit: q,
                    product,
                    offset: stepIndex  // product for step i goes under column i (after i spacers)
                });
                current = current - product;
                position++;
            }
            return { quotientDigits, remainder: current, steps };
        }

        function createDivisionProblem(problem) {
            const container = document.getElementById('divisionProblem');
            container.innerHTML = '';
            allInputs = [];

            const dividend = problem.dividend;
            const divisor = problem.divisor;
            const quotient = problem.quotient;
            const remainder = problem.remainder;
            const dividendStr = String(dividend);
            const divisorStr = String(divisor);
            const quotientStr = String(quotient);
            const remainderStr = String(remainder);

            const { quotientDigits, steps } = computeLongDivisionSteps(dividend, divisor);
            const totalCols = dividendStr.length;
            const quotientLen = quotientStr.length;
            // Left offset so first input is directly over leftmost digit of numerator (divisor cell + bracket width)
            const digitWidth = 46;
            const bracketWidth = 28;
            const leftOffsetPx = (divisorStr.length * digitWidth) + bracketWidth;

            // ---- Quotient line: [leftOffset][q0][q1]...[qk] R [rem]
            const quotientRow = document.createElement('div');
            quotientRow.className = 'division-row';
            const leftSpacer = document.createElement('div');
            leftSpacer.className = 'spacer-left';
            leftSpacer.style.width = leftOffsetPx + 'px';
            leftSpacer.style.minWidth = leftOffsetPx + 'px';
            quotientRow.appendChild(leftSpacer);
            const quotientSpacers = totalCols - quotientLen;
            for (let s = 0; s < quotientSpacers; s++) {
                const sp = document.createElement('div');
                sp.className = 'spacer';
                quotientRow.appendChild(sp);
            }
            const quotientInputs = [];
            for (let i = 0; i < quotientLen; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'digit-cell input';
                input.setAttribute('readonly', 'readonly');
                input.setAttribute('inputmode', 'none');
                input.readOnly = true;
                input.maxLength = 1;
                input.dataset.correctValue = quotientStr[i];
                input.style.textAlign = 'center';
                input.addEventListener('input', (e) => handleAnyInput(e));
                input.addEventListener('keydown', (e) => handleKeyDown(e, input));
                quotientRow.appendChild(input);
                quotientInputs.push(input);
            }
            const rSpan = document.createElement('span');
            rSpan.className = 'division-r';
            rSpan.textContent = ' R ';
            quotientRow.appendChild(rSpan);
            const remainderInputs = [];
            for (let i = 0; i < remainderStr.length; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'digit-cell input';
                input.setAttribute('readonly', 'readonly');
                input.setAttribute('inputmode', 'none');
                input.readOnly = true;
                input.maxLength = 1;
                input.dataset.correctValue = remainderStr[i];
                input.style.textAlign = 'center';
                input.addEventListener('input', (e) => handleAnyInput(e));
                input.addEventListener('keydown', (e) => handleKeyDown(e, input));
                quotientRow.appendChild(input);
                remainderInputs.push(input);
            }
            container.appendChild(quotientRow);

            // ---- Bracket row: same leading spacers as quotient, then divisor ) dividend
            const bracketRow = document.createElement('div');
            bracketRow.className = 'division-row';
            for (let s = 0; s < quotientSpacers; s++) {
                const sp = document.createElement('div');
                sp.className = 'spacer';
                bracketRow.appendChild(sp);
            }
            const divCell = document.createElement('div');
            divCell.className = 'digit-cell';
            divCell.style.minWidth = (divisorStr.length * 46) + 'px';
            divCell.textContent = divisorStr;
            bracketRow.appendChild(divCell);
            const bracketCell = document.createElement('div');
            bracketCell.className = 'division-bracket';
            bracketCell.textContent = ')';
            bracketCell.style.fontSize = '1.8rem';
            bracketRow.appendChild(bracketCell);
            for (let i = 0; i < dividendStr.length; i++) {
                const cell = document.createElement('div');
                cell.className = 'digit-cell';
                cell.textContent = dividendStr[i];
                bracketRow.appendChild(cell);
            }
            container.appendChild(bracketRow);

            // ---- Steps: for each step, a row with leftOffset then (quotientSpacers + offset) spacers then product digits (inputs)
            steps.forEach((step, idx) => {
                const productStr = String(step.product);
                const row = document.createElement('div');
                row.className = 'division-row';
                const stepLeftSpacer = document.createElement('div');
                stepLeftSpacer.className = 'spacer-left';
                stepLeftSpacer.style.width = leftOffsetPx + 'px';
                stepLeftSpacer.style.minWidth = leftOffsetPx + 'px';
                row.appendChild(stepLeftSpacer);
                const numSpacers = quotientSpacers + step.offset;
                for (let s = 0; s < numSpacers; s++) {
                    const sp = document.createElement('div');
                    sp.className = 'spacer';
                    row.appendChild(sp);
                }
                for (let d = 0; d < productStr.length; d++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'digit-cell input';
                    input.setAttribute('readonly', 'readonly');
                    input.setAttribute('inputmode', 'none');
                    input.readOnly = true;
                    input.maxLength = 1;
                    input.dataset.correctValue = productStr[d];
                    input.style.textAlign = 'center';
                    input.addEventListener('input', (e) => handleAnyInput(e));
                    input.addEventListener('keydown', (e) => handleKeyDown(e, input));
                    row.appendChild(input);
                }
                container.appendChild(row);
                const lineRow = document.createElement('div');
                lineRow.className = 'division-row';
                const lineLeftSpacer = document.createElement('div');
                lineLeftSpacer.className = 'spacer-left';
                lineLeftSpacer.style.width = leftOffsetPx + 'px';
                lineLeftSpacer.style.minWidth = leftOffsetPx + 'px';
                lineRow.appendChild(lineLeftSpacer);
                for (let s = 0; s < numSpacers; s++) {
                    const sp = document.createElement('div');
                    sp.className = 'spacer';
                    lineRow.appendChild(sp);
                }
                const line = document.createElement('div');
                line.className = 'division-line';
                line.style.width = (productStr.length * 46) + 'px';
                lineRow.appendChild(line);
                container.appendChild(lineRow);
            });

            // Build allInputs: step-by-step order: q0, product0 digits, q1, product1 digits, ..., then remainder digits
            allInputs = [];
            for (let i = 0; i < steps.length; i++) {
                allInputs.push(quotientInputs[i]);
                const productRow = container.children[2 + i * 2];
                const inputsInRow = productRow.querySelectorAll('.digit-cell.input');
                for (let j = 0; j < inputsInRow.length; j++) {
                    allInputs.push(inputsInRow[j]);
                }
            }
            for (let i = 0; i < remainderInputs.length; i++) {
                allInputs.push(remainderInputs[i]);
            }

            if (allInputs.length > 0) allInputs[0].focus();
        }

        function handleAnyInput(e) {
            const input = e.target;
            const value = input.value;
            if (value && !/^\d$/.test(value)) {
                input.value = '';
                showError('Please enter a digit 0-9');
                input.classList.add('error');
                setTimeout(() => { input.classList.remove('error'); clearError(); }, 2000);
                return;
            }
            const correct = input.dataset.correctValue;
            if (String(value) === correct) {
                input.classList.remove('error');
                input.style.borderColor = 'var(--correct-color)';
                input.style.background = '#e8f5e9';
                clearError();
                if (!skipCursorMove) {
                    const idx = allInputs.indexOf(input);
                    if (idx < allInputs.length - 1) {
                        allInputs[idx + 1].focus();
                    } else {
                        checkComplete();
                    }
                } else {
                    checkComplete();
                }
            } else if (value !== '') {
                input.classList.add('error');
                showError('Try again! Expected ' + correct + '.');
                setTimeout(() => { input.classList.remove('error'); clearError(); }, 2000);
            }
        }

        function handleKeyDown(e, input) {
            const idx = allInputs.indexOf(input);
            if (e.key === 'Backspace' && input.value === '' && idx > 0) {
                e.preventDefault();
                allInputs[idx - 1].focus();
            } else if (e.key === 'ArrowLeft' && idx > 0) {
                e.preventDefault();
                allInputs[idx - 1].focus();
            } else if (e.key === 'ArrowRight' && idx < allInputs.length - 1) {
                e.preventDefault();
                allInputs[idx + 1].focus();
            }
        }

        function checkComplete() {
            let allCorrect = true;
            let allFilled = true;
            allInputs.forEach(inp => {
                if (!inp.value) allFilled = false;
                if (inp.value !== inp.dataset.correctValue) allCorrect = false;
            });
            if (allFilled && allCorrect) {
                createConfetti();
                correctCount++;
                score++;
                questionsCompleted++;
                document.getElementById('score').textContent = score;
                document.getElementById('progress').textContent = questionsCompleted;
                document.getElementById('nextButton').style.display = 'block';
                if (questionsCompleted >= maxQuestions) {
                    document.getElementById('nextButton').textContent = 'Finish Game';
                }
                allInputs.forEach(inp => { inp.disabled = true; });
            }
        }

        function showError(msg) { document.getElementById('errorMessage').textContent = msg; }
        function clearError() {
            const el = document.getElementById('errorMessage');
            if (el.textContent) setTimeout(() => { el.textContent = ''; }, 2000);
        }

        function loadNextProblem() {
            if (questionsCompleted >= maxQuestions) {
                endGame();
                return;
            }
            if (currentProblemIndex >= problems.length) {
                currentProblemIndex = 0;
                shuffleArray(problems);
            }
            currentProblem = problems[currentProblemIndex++];
            document.getElementById('question').textContent = currentProblem.question;
            document.getElementById('nextButton').style.display = 'none';
            document.getElementById('nextButton').textContent = 'Next Question';
            document.getElementById('errorMessage').textContent = '';
            document.getElementById('hintText').textContent = 'Tip: Divide from left to right. Multiply divisor Ã— quotient digit, subtract, bring down.';
            createDivisionProblem(currentProblem);
        }

        function createConfetti() {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE'];
            const container = document.body;
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function endGame() {
            document.getElementById('question').innerHTML = '<h2>ðŸŽ‰ Game Complete! ðŸŽ‰</h2><p>Final Score: ' + correctCount + '/' + maxQuestions + ' correct!</p>';
            document.getElementById('divisionProblem').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('hintText').style.display = 'none';
            document.getElementById('nextButton').style.display = 'none';
            if (window.Android && typeof window.Android.gameCompleted === 'function') {
                window.Android.gameCompleted(correctCount, incorrectCount);
            } else if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'gameCompleted', correct: correctCount, incorrect: incorrectCount }, '*');
            }
            setTimeout(() => {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'closeModal' }, '*');
                } else {
                    history.back();
                }
            }, 3000);
        }

        let currentFocusedInput = null;
        function setupNumberPad() {
            document.querySelectorAll('.number-pad-button[data-number]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const num = btn.dataset.number;
                    if (currentFocusedInput && !currentFocusedInput.disabled && currentFocusedInput.classList.contains('input')) {
                        if (currentFocusedInput.maxLength === 1 && currentFocusedInput.value === '') {
                            currentFocusedInput.value = num;
                            skipCursorMove = true;
                            currentFocusedInput.dispatchEvent(new Event('input'));
                            const idx = allInputs.indexOf(currentFocusedInput);
                            if (idx < allInputs.length - 1) allInputs[idx + 1].focus();
                            else checkComplete();
                        }
                    }
                });
            });
            document.getElementById('deleteButton').addEventListener('click', () => {
                if (currentFocusedInput && !currentFocusedInput.disabled) {
                    if (currentFocusedInput.value.length > 0) {
                        currentFocusedInput.value = '';
                        currentFocusedInput.dispatchEvent(new Event('input'));
                    } else {
                        const idx = allInputs.indexOf(currentFocusedInput);
                        if (idx > 0) allInputs[idx - 1].focus();
                    }
                }
            });
            document.addEventListener('focusin', (e) => {
                if (e.target.classList.contains('input')) currentFocusedInput = e.target;
            });
            document.addEventListener('focusout', (e) => {
                if (e.target === currentFocusedInput) {
                    setTimeout(() => {
                        if (document.activeElement && !document.activeElement.classList.contains('input')) currentFocusedInput = null;
                    }, 100);
                }
            });
        }

        window.addEventListener('load', () => {
            loadConfig();
            const maxEl = document.getElementById('maxQuestions');
            if (maxEl) maxEl.textContent = maxQuestions;
            generateProblems();
            setupNumberPad();
            loadNextProblem();
        });

        document.getElementById('nextButton').addEventListener('click', () => {
            if (questionsCompleted >= maxQuestions) endGame();
            else loadNextProblem();
        });
    </script>
</body>
</html>
