<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What Happens Next?</title>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Chalkboard', 'Arial Rounded MT Bold', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        #starCount {
            text-align: center;
            font-size: 24px;
            color: #ffcc00;
            margin-bottom: 20px;
        }
        .story-display {
            background: #f0f8ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
            font-size: 1.1em;
            line-height: 1.6;
            min-height: 150px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .question {
            text-align: center;
            font-size: 1.4em;
            color: #764ba2;
            font-weight: bold;
            margin: 20px 0;
        }
        .options-container {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }
        .option {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 12px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .option:hover {
            background: #e3f2fd;
            border-color: #ff8c00;
            transform: translateX(10px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .option.selected {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .option.correct {
            background: #c8e6c9;
            border-color: #4CAF50;
        }
        .option.incorrect {
            background: #ffcdd2;
            border-color: #f44336;
        }
        .option::before {
            content: '‚óã';
            margin-right: 10px;
            font-size: 1.2em;
        }
        .option.selected::before {
            content: '‚óè';
        }
        .button {
            font-family: inherit;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            padding: 15px 30px;
            font-size: 1.2em;
            color: white;
            background: #667eea;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            margin: 10px;
        }
        .button:hover {
            background: #ff8c00;
            transform: scale(1.05);
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .button-container {
            text-align: center;
            margin: 20px 0;
        }
        .feedback {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            animation: popIn 0.5s ease;
        }
        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üìñ What Happens Next? üìñ</h1>
        <div id="starCount">‚≠ê 0 / 5</div>
        
        <div class="story-display" id="storyDisplay">
            <p>Loading story...</p>
        </div>
        
        <div class="question">What do you think happens next?</div>
        
        <div class="options-container" id="optionsContainer"></div>
        
        <div id="feedbackContainer"></div>
        
        <div class="button-container">
            <button class="button" id="submitButton" onclick="submitAnswer()">Submit Answer</button>
            <button class="button hidden" id="nextButton" onclick="nextStory()">Next Story ‚Üí</button>
        </div>
    </div>

    <script>
        function readText(text, lang, rate = 0.8, onEndCallback = null) {
            if (window.Android && typeof window.Android.readText === 'function') {
                window.Android.readText(text, lang);
                setTimeout(() => {
                    if (onEndCallback) onEndCallback();
                }, 1000);
            } else if ('speechSynthesis' in window) {
                if (window.currentTTSUtterance) window.speechSynthesis.cancel();
                window.currentTTSUtterance = new SpeechSynthesisUtterance(text);
                window.currentTTSUtterance.lang = lang;
                window.currentTTSUtterance.rate = rate;
                window.currentTTSUtterance.onend = () => {
                    if (onEndCallback) onEndCallback();
                    window.currentTTSUtterance = null;
                };
                window.speechSynthesis.speak(window.currentTTSUtterance);
            } else {
                if (onEndCallback) onEndCallback();
            }
        }

        let stories = [];
        let currentStoryIndex = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        let maxQuestions = 5;
        let currentStory = null;
        let selectedOption = null;
        let isFirstAttempt = true;

        const defaultStories = [
            {
                story: "It was a sunny day at the park. Sarah was playing on the swings when she noticed a small puppy sitting alone near the bench. The puppy looked sad and lost.",
                options: [
                    "Sarah kept swinging and ignored the puppy.",
                    "Sarah went to find the puppy's owner to help.",
                    "Sarah went home because it was getting late.",
                    "Sarah started playing with her friends instead."
                ],
                correct: 1
            },
            {
                story: "Tom was building a tall tower with blocks. He had stacked them very high, almost to the ceiling. The tower was starting to wobble a little bit.",
                options: [
                    "Tom added more blocks to make it even taller.",
                    "Tom carefully added a support block to make it stable.",
                    "Tom knocked it down and started over.",
                    "Tom walked away and left the tower."
                ],
                correct: 1
            },
            {
                story: "Emma was reading her favorite book when she heard a loud crash from the kitchen. She put down her book and ran to see what happened.",
                options: [
                    "Emma went back to reading her book.",
                    "Emma found a broken plate on the floor and helped clean it up.",
                    "Emma decided to go outside and play.",
                    "Emma went to her room to get a new book."
                ],
                correct: 1
            },
            {
                story: "The rain started falling heavily outside. Jake was about to go to the playground with his friends, but now the ground was getting wet and muddy.",
                options: [
                    "Jake went outside anyway and got very wet.",
                    "Jake and his friends decided to play board games inside instead.",
                    "Jake went to bed because he was tired.",
                    "Jake forgot about his friends and watched TV alone."
                ],
                correct: 1
            },
            {
                story: "Lily was helping her mom bake cookies. They had mixed all the ingredients and put the cookies in the oven. The timer went off, and the cookies smelled delicious.",
                options: [
                    "Lily opened the oven and ate the cookies right away.",
                    "Lily waited for the cookies to cool down before eating one.",
                    "Lily went to play outside and forgot about the cookies.",
                    "Lily turned off the oven and left the cookies inside."
                ],
                correct: 1
            }
        ];

        function getGameConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const file = urlParams.get('file');
            return file || 'whatHappensNext.json';
        }

        function loadStories() {
            const fileName = getGameConfig();
            const isAndroid = window.Android !== undefined;
            
            if (isAndroid) {
                // Use Android interface to load JSON from assets
                try {
                    const jsonString = window.Android.loadJsonFile(fileName);
                    const data = JSON.parse(jsonString);
                    if (Array.isArray(data) && data.length > 0) {
                        stories = data;
                    } else {
                        stories = defaultStories;
                    }
                    maxQuestions = Math.min(stories.length, maxQuestions);
                    startGame();
                } catch (error) {
                    console.log('Using default stories');
                    stories = defaultStories;
                    maxQuestions = Math.min(stories.length, maxQuestions);
                    startGame();
                }
            } else {
                // Use fetch for web
                const jsonUrl = `../data/${fileName}`;
                fetch(jsonUrl)
                    .then(response => {
                        if (response.ok) return response.json();
                        throw new Error('File not found');
                    })
                    .then(data => {
                        if (Array.isArray(data) && data.length > 0) {
                            stories = data;
                        } else {
                            stories = defaultStories;
                        }
                        maxQuestions = Math.min(stories.length, maxQuestions);
                        startGame();
                    })
                    .catch(error => {
                        console.log('Using default stories');
                        stories = defaultStories;
                        maxQuestions = Math.min(stories.length, maxQuestions);
                        startGame();
                    });
            }
        }

        function startGame() {
            currentStoryIndex = 0;
            correctCount = 0;
            incorrectCount = 0;
            updateStarCount();
            loadStory();
        }

        function loadStory() {
            if (currentStoryIndex >= maxQuestions) {
                endGame();
                return;
            }

            currentStory = stories[currentStoryIndex];
            selectedOption = null;
            isFirstAttempt = true;
            
            document.getElementById('storyDisplay').innerHTML = `<p>${currentStory.story}</p>`;
            document.getElementById('feedbackContainer').innerHTML = '';
            document.getElementById('submitButton').disabled = false;
            document.getElementById('nextButton').classList.add('hidden');

            createOptions();
            
            setTimeout(() => {
                readText(currentStory.story, 'en-US', 0.7);
            }, 500);
        }

        function createOptions() {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            currentStory.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.dataset.index = index;
                optionDiv.onclick = () => selectOption(optionDiv, index);
                container.appendChild(optionDiv);
            });
        }

        function selectOption(optionDiv, index) {
            // Remove previous selection
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            optionDiv.classList.add('selected');
            selectedOption = index;
        }

        function submitAnswer() {
            if (selectedOption === null) {
                document.getElementById('feedbackContainer').innerHTML = 
                    '<div class="feedback incorrect">Please select an answer first!</div>';
                setTimeout(() => {
                    document.getElementById('feedbackContainer').innerHTML = '';
                }, 2000);
                return;
            }

            const isCorrect = selectedOption === currentStory.correct;
            const options = document.querySelectorAll('.option');
            
            options.forEach((opt, index) => {
                opt.onclick = null; // Disable further clicks
                if (index === currentStory.correct) {
                    opt.classList.add('correct');
                } else if (index === selectedOption && !isCorrect) {
                    opt.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                document.getElementById('feedbackContainer').innerHTML = 
                    '<div class="feedback correct">‚úì Great thinking! That makes sense! üéâ</div>';
                if (isFirstAttempt) {
                    correctCount++;
                    updateStarCount();
                }
                document.getElementById('submitButton').disabled = true;
                setTimeout(() => {
                    document.getElementById('nextButton').classList.remove('hidden');
                }, 2000);
            } else {
                if (isFirstAttempt) {
                    incorrectCount++;
                    isFirstAttempt = false;
                }
                document.getElementById('feedbackContainer').innerHTML = 
                    '<div class="feedback incorrect">‚úó Not quite. Think about what would make the most sense!</div>';
                document.getElementById('submitButton').disabled = true;
                setTimeout(() => {
                    document.getElementById('nextButton').classList.remove('hidden');
                }, 2000);
            }
        }

        function nextStory() {
            currentStoryIndex++;
            loadStory();
        }

        function updateStarCount() {
            document.getElementById("starCount").innerText = `‚≠ê ${correctCount} / ${maxQuestions}`;
        }

        function endGame() {
            document.getElementById('storyDisplay').innerHTML = 
                `<h2>üéâ Game Complete! üéâ</h2><p>Final Score: ${correctCount}/${maxQuestions}‚≠ê</p>`;
            document.getElementById('optionsContainer').innerHTML = '';
            document.querySelector('.button-container').innerHTML = '';
            
            if (window.Android && typeof window.Android.gameCompleted === 'function') {
                window.Android.gameCompleted(correctCount, incorrectCount);
            } else if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'gameCompleted', correct: correctCount, incorrect: incorrectCount }, '*');
            }
            setTimeout(() => {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'closeModal' }, '*');
                } else {
                    history.back();
                }
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', loadStories);
    </script>
</body>
</html>

