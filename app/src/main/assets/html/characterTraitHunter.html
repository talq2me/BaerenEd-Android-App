<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Trait Hunter</title>
    <style>
        body {
            font-family: 'Comic Sans MS', 'Chalkboard', 'Arial Rounded MT Bold', sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .game-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #f5576c;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        #starCount {
            text-align: center;
            font-size: 24px;
            color: #ffcc00;
            margin-bottom: 20px;
        }
        .story-display {
            background: #f0f8ff;
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            font-size: 1.2em;
            line-height: 1.8;
            min-height: 200px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .highlighted {
            background: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
        }
        .instructions {
            text-align: center;
            color: #f5576c;
            font-size: 1.2em;
            margin: 15px 0;
            font-weight: bold;
        }
        .trait-bank {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            min-height: 80px;
        }
        .trait-item {
            background: #4CAF50;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .trait-item:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .trait-item.selected {
            background: #2196F3;
        }
        .trait-item.used {
            opacity: 0.3;
            cursor: not-allowed;
            background: #ccc;
        }
        .matches-container {
            background: #e8f5e9;
            border: 3px solid #4CAF50;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 150px;
        }
        .match-item {
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .match-trait {
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
        }
        .match-evidence {
            flex: 1;
            font-style: italic;
            color: #555;
        }
        .match-evidence.highlighted {
            background: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .button {
            font-family: inherit;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            padding: 15px 30px;
            font-size: 1.2em;
            color: white;
            background: #f5576c;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            margin: 10px;
        }
        .button:hover {
            background: #ff8c00;
            transform: scale(1.05);
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .button-container {
            text-align: center;
            margin: 20px 0;
        }
        .feedback {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            animation: popIn 0.5s ease;
        }
        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üîç Character Trait Hunter üîç</h1>
        <div id="starCount">‚≠ê 0 / 5</div>
        
        <div class="story-display" id="storyDisplay">
            <p>Loading story...</p>
        </div>
        
        <div class="instructions" id="instructions">
            Click traits below, then find evidence in the story!
        </div>
        
        <div class="trait-bank" id="traitBank"></div>
        
        <div class="matches-container" id="matchesContainer">
            <h3 style="margin-top: 0;">Your Matches:</h3>
            <div id="matchesList"></div>
        </div>
        
        <div id="feedbackContainer"></div>
        
        <div class="button-container">
            <button class="button" id="checkButton" onclick="checkMatches()">‚úì Check Matches</button>
            <button class="button hidden" id="nextButton" onclick="nextStory()">Next Story ‚Üí</button>
        </div>
    </div>

    <script>
        function readText(text, lang, rate = 0.8, onEndCallback = null) {
            if (window.Android && typeof window.Android.readText === 'function') {
                window.Android.readText(text, lang);
                setTimeout(() => {
                    if (onEndCallback) onEndCallback();
                }, 1000);
            } else if ('speechSynthesis' in window) {
                if (window.currentTTSUtterance) window.speechSynthesis.cancel();
                window.currentTTSUtterance = new SpeechSynthesisUtterance(text);
                window.currentTTSUtterance.lang = lang;
                window.currentTTSUtterance.rate = rate;
                window.currentTTSUtterance.onend = () => {
                    if (onEndCallback) onEndCallback();
                    window.currentTTSUtterance = null;
                };
                window.speechSynthesis.speak(window.currentTTSUtterance);
            } else {
                if (onEndCallback) onEndCallback();
            }
        }

        let stories = [];
        let currentStoryIndex = 0;
        let correctCount = 0;
        let incorrectCount = 0;
        let maxQuestions = 5;
        let currentStory = null;
        let selectedTrait = null;
        let matches = [];

        const defaultStories = [
            {
                story: "Emma loved to help others. Every day after school, she would help her little brother with his homework. She also helped her mom set the table for dinner. When her friend was sad, Emma always tried to make them feel better.",
                traits: ["helpful", "kind", "caring", "brave", "shy"],
                correctTraits: ["helpful", "kind", "caring"],
                evidence: {
                    "helpful": "helped her little brother with his homework",
                    "kind": "tried to make them feel better",
                    "caring": "helped her mom set the table"
                }
            },
            {
                story: "Jake was very brave. When he saw a big dog, he wasn't scared. He stood up for his friend when someone was being mean. Jake also tried new foods even when they looked strange.",
                traits: ["brave", "scared", "mean", "curious", "lazy"],
                correctTraits: ["brave", "curious"],
                evidence: {
                    "brave": "stood up for his friend when someone was being mean",
                    "curious": "tried new foods even when they looked strange"
                }
            },
            {
                story: "Maya was always happy and cheerful. She smiled at everyone she met. Maya loved to play games and make people laugh. Her friends always felt better when they were around her.",
                traits: ["happy", "sad", "angry", "cheerful", "tired"],
                correctTraits: ["happy", "cheerful"],
                evidence: {
                    "happy": "smiled at everyone she met",
                    "cheerful": "loved to play games and make people laugh"
                }
            },
            {
                story: "Sam worked very hard on his school project. He spent hours reading books and drawing pictures. Sam didn't give up even when it was difficult. His teacher was proud of his effort.",
                traits: ["hardworking", "lazy", "smart", "patient", "impatient"],
                correctTraits: ["hardworking", "patient"],
                evidence: {
                    "hardworking": "spent hours reading books and drawing pictures",
                    "patient": "didn't give up even when it was difficult"
                }
            },
            {
                story: "Lily was very creative. She loved to paint and draw. She made up stories and songs. Lily always had new ideas for games to play with her friends.",
                traits: ["creative", "boring", "artistic", "fun", "serious"],
                correctTraits: ["creative", "artistic"],
                evidence: {
                    "creative": "made up stories and songs",
                    "artistic": "loved to paint and draw"
                }
            }
        ];

        function loadStories() {
            fetch('../data/characterTraits.json')
                .then(response => {
                    if (response.ok) return response.json();
                    throw new Error('File not found');
                })
                .then(data => {
                    if (Array.isArray(data) && data.length > 0) {
                        stories = data;
                    } else {
                        stories = defaultStories;
                    }
                    maxQuestions = Math.min(stories.length, maxQuestions);
                    startGame();
                })
                .catch(error => {
                    console.log('Using default stories');
                    stories = defaultStories;
                    maxQuestions = Math.min(stories.length, maxQuestions);
                    startGame();
                });
        }

        function startGame() {
            currentStoryIndex = 0;
            correctCount = 0;
            incorrectCount = 0;
            updateStarCount();
            loadStory();
        }

        function loadStory() {
            if (currentStoryIndex >= maxQuestions) {
                endGame();
                return;
            }

            currentStory = stories[currentStoryIndex];
            selectedTrait = null;
            matches = [];
            
            document.getElementById('storyDisplay').innerHTML = `<p>${currentStory.story}</p>`;
            document.getElementById('feedbackContainer').innerHTML = '';
            document.getElementById('matchesList').innerHTML = '';
            document.getElementById('checkButton').disabled = false;
            document.getElementById('nextButton').classList.add('hidden');

            createTraitBank();
            
            setTimeout(() => {
                readText(currentStory.story, 'en-US', 0.7);
            }, 500);
        }

        function createTraitBank() {
            const bank = document.getElementById('traitBank');
            bank.innerHTML = '';
            
            currentStory.traits.forEach(trait => {
                const item = document.createElement('div');
                item.className = 'trait-item';
                item.textContent = trait;
                item.dataset.trait = trait;
                item.onclick = () => selectTrait(item, trait);
                bank.appendChild(item);
            });
        }

        function selectTrait(item, trait) {
            if (item.classList.contains('used')) return;
            
            // Remove previous selection
            document.querySelectorAll('.trait-item').forEach(t => t.classList.remove('selected'));
            item.classList.add('selected');
            selectedTrait = trait;
            
            // Highlight evidence in story
            highlightEvidence(trait);
        }

        function highlightEvidence(trait) {
            const storyDisplay = document.getElementById('storyDisplay');
            const storyText = currentStory.story;
            
            if (currentStory.evidence && currentStory.evidence[trait]) {
                const evidence = currentStory.evidence[trait];
                let highlightedText = storyText;
                
                // Remove previous highlights
                highlightedText = highlightedText.replace(/<span class="highlighted">(.*?)<\/span>/g, '$1');
                
                // Add new highlight
                if (highlightedText.includes(evidence)) {
                    highlightedText = highlightedText.replace(
                        evidence,
                        `<span class="highlighted">${evidence}</span>`
                    );
                }
                
                storyDisplay.innerHTML = `<p>${highlightedText}</p>`;
            }
        }

        function addMatch() {
            if (!selectedTrait) {
                document.getElementById('feedbackContainer').innerHTML = 
                    '<div class="feedback incorrect">Please select a trait first!</div>';
                setTimeout(() => {
                    document.getElementById('feedbackContainer').innerHTML = '';
                }, 2000);
                return;
            }

            // Check if already matched
            if (matches.find(m => m.trait === selectedTrait)) {
                document.getElementById('feedbackContainer').innerHTML = 
                    '<div class="feedback incorrect">You already matched this trait!</div>';
                setTimeout(() => {
                    document.getElementById('feedbackContainer').innerHTML = '';
                }, 2000);
                return;
            }

            const evidence = currentStory.evidence && currentStory.evidence[selectedTrait] 
                ? currentStory.evidence[selectedTrait] 
                : 'No evidence found';

            matches.push({
                trait: selectedTrait,
                evidence: evidence
            });

            updateMatchesDisplay();
            
            // Mark trait as used
            document.querySelectorAll('.trait-item').forEach(item => {
                if (item.dataset.trait === selectedTrait) {
                    item.classList.add('used');
                    item.classList.remove('selected');
                }
            });
            
            selectedTrait = null;
        }

        function updateMatchesDisplay() {
            const list = document.getElementById('matchesList');
            list.innerHTML = '';
            
            matches.forEach(match => {
                const item = document.createElement('div');
                item.className = 'match-item';
                item.innerHTML = `
                    <div class="match-trait">${match.trait}</div>
                    <div class="match-evidence">${match.evidence}</div>
                `;
                list.appendChild(item);
            });
        }

        function checkMatches() {
            const correctTraits = currentStory.correctTraits || [];
            const matchedTraits = matches.map(m => m.trait);
            
            let correctMatches = 0;
            let hasIncorrect = false;
            
            matchedTraits.forEach(trait => {
                if (correctTraits.includes(trait)) {
                    correctMatches++;
                } else {
                    hasIncorrect = true;
                }
            });
            
            const allCorrect = correctMatches === correctTraits.length && 
                              matchedTraits.length === correctTraits.length &&
                              !hasIncorrect;

            if (allCorrect) {
                document.getElementById('feedbackContainer').innerHTML = 
                    '<div class="feedback correct">‚úì Perfect! You found all the character traits! üéâ</div>';
                correctCount++;
                updateStarCount();
                document.getElementById('checkButton').disabled = true;
                setTimeout(() => {
                    document.getElementById('nextButton').classList.remove('hidden');
                }, 2000);
            } else {
                incorrectCount++;
                document.getElementById('feedbackContainer').innerHTML = 
                    '<div class="feedback incorrect">‚úó Not quite right. Try matching different traits!</div>';
                setTimeout(() => {
                    document.getElementById('feedbackContainer').innerHTML = '';
                }, 2000);
            }
        }

        function nextStory() {
            currentStoryIndex++;
            loadStory();
        }

        function updateStarCount() {
            document.getElementById("starCount").innerText = `‚≠ê ${correctCount} / ${maxQuestions}`;
        }

        function endGame() {
            document.getElementById('storyDisplay').innerHTML = 
                `<h2>üéâ Game Complete! üéâ</h2><p>Final Score: ${correctCount}/${maxQuestions}‚≠ê</p>`;
            document.getElementById('traitBank').innerHTML = '';
            document.getElementById('matchesList').innerHTML = '';
            document.querySelector('.button-container').innerHTML = '';
            
            if (window.Android && typeof window.Android.gameCompleted === 'function') {
                window.Android.gameCompleted(correctCount, incorrectCount);
            } else if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'gameCompleted', correct: correctCount, incorrect: incorrectCount }, '*');
            }
            setTimeout(() => {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'closeModal' }, '*');
                } else {
                    history.back();
                }
            }, 3000);
        }

        // Allow clicking on highlighted text to add match
        document.addEventListener('DOMContentLoaded', () => {
            loadStories();
            
            document.getElementById('storyDisplay').addEventListener('click', (e) => {
                if (e.target.classList.contains('highlighted') && selectedTrait) {
                    addMatch();
                }
            });
        });
    </script>
</body>
</html>

